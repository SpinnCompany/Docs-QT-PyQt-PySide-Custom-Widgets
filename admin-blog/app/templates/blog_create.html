{% extends 'layout/base.html' %}
{% block title %}{% if post %}Edit{% else %}Create{% endif %} Blog - Docusaurus{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
  <!-- Header -->
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
    <h1 class="text-2xl font-bold mb-2 dark:text-white flex items-center space-x-2">
      <i class="fas {% if post %}fa-edit{% else %}fa-plus-circle{% endif %} text-blue-500"></i>
      <span>{% if post %}Edit{% else %}Create New{% endif %} Blog Post</span>
    </h1>
    <p class="text-gray-600 dark:text-gray-400">
      {% if post %}
        Edit your existing blog post for your Docusaurus site
      {% else %}
        Create a new blog post for your Docusaurus site
      {% endif %}
    </p>
  </div>

  <!-- Blog Form -->
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
    <form action="{% if post %}{{ url_for('dashboard.blog_edit', slug=post.slug) }}{% else %}{{ url_for('dashboard.blog_create') }}{% endif %}" method="POST" class="space-y-6">
      
      <!-- Title & Slug Row -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Title -->
        <div class="form-group">
          <label for="title" class="form-label">
            <i class="fas fa-heading text-blue-500 mr-2"></i>
            Blog Title *
          </label>
          <input type="text" id="title" name="title" required
                 class="form-input"
                 placeholder="Enter your blog post title"
                 value="{{ post.title if post }}">
        </div>

        <!-- Slug -->
        <div class="form-group">
          <label for="slug" class="form-label">
            <i class="fas fa-link text-green-500 mr-2"></i>
            URL Slug
          </label>
          <input type="text" id="slug" name="slug" 
                 class="form-input"
                 placeholder="auto-generated-from-title"
                 value="{{ post.slug if post }}"
                 oninput="this.value = this.value.toLowerCase().replace(/[^a-z0-9-]/g, '-')">
          <p class="form-help-text">Will be used in the blog URL</p>
        </div>
      </div>

      <!-- Authors & Tags Row -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Authors -->
        <div class="form-group">
          <label for="authors" class="form-label">
            <i class="fas fa-users text-purple-500 mr-2"></i>
            Authors
          </label>
          <input type="text" id="authors" name="authors" 
                 class="form-input"
                 placeholder="Khamisi Kibet, John Doe"
                 value="{{ post.authors | join(', ') if post and post.authors }}">
          <p class="form-help-text">Separate with commas</p>
        </div>

        <!-- Tags -->
        <div class="form-group">
          <label for="tags" class="form-label">
            <i class="fas fa-tags text-orange-500 mr-2"></i>
            Tags
          </label>
          <input type="text" id="tags" name="tags" 
                 class="form-input"
                 placeholder="PySide6, Widgets, Tutorial"
                 value="{{ post.tags | join(', ') if post and post.tags }}">
          <p class="form-help-text">Separate with commas</p>
        </div>
      </div>

      <!-- File Type & Status -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- File Type -->
        <div class="form-group">
          <label for="type" class="form-label">
            <i class="fas fa-file-code text-indigo-500 mr-2"></i>
            File Type
          </label>
          <select id="type" name="type" class="form-input">
            <option value="md" {% if post and post.filename.endswith('.md') %}selected{% endif %}>Markdown (.md)</option>
            <option value="mdx" {% if post and post.filename.endswith('.mdx') %}selected{% endif %}>MDX (.mdx)</option>
          </select>
        </div>

        <!-- Current Status Display -->
        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-info-circle text-blue-500 mr-2"></i>
            Current Status
          </label>
          <div class="mt-2">
            {% if post %}
              {% if post.draft %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">
                  <i class="fas fa-edit mr-1"></i> Draft
                </span>
              {% else %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                  <i class="fas fa-check-circle mr-1"></i> Published
                </span>
              {% endif %}
            {% else %}
              <span class="text-gray-500 dark:text-gray-400 text-sm">New post</span>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Content -->
      <div class="form-group">
        <label for="content" class="form-label">
          <i class="fas fa-edit text-gray-600 mr-2"></i>
          Blog Content *
        </label>
        <textarea id="content" name="content" rows="20" required
                  class="form-input font-mono text-sm"
                  placeholder="# Welcome to your new blog post!

Start writing your content here using Markdown syntax.

<!-- truncate -->

Add the truncate comment above to specify where the preview should end.

## Features
- **Markdown** support
- **Code blocks**
- **Images** and more!">{% if post %}{{ post.content }}{% endif %}</textarea>
        
        <div class="flex justify-between items-center mt-2">
          <p class="form-help-text">
            Use Markdown syntax. Add <code class="bg-gray-100 dark:bg-gray-700 px-1 rounded">&#x3C;!-- truncate --&#x3E;</code> to mark preview end.
          </p>
          <span class="text-xs text-gray-500" id="charCount">{% if post %}{{ post.content | length }}{% else %}0{% endif %} characters</span>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="flex justify-between items-center pt-6 border-t border-gray-200 dark:border-gray-700">
        <a href="{{ url_for('dashboard.blog_list') }}" 
           class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
          <i class="fas fa-arrow-left mr-2"></i> Back to Posts
        </a>
        
        <div class="space-x-3">
          <button type="submit" name="action" value="draft" 
                  class="inline-flex items-center px-4 py-2 border border-yellow-300 rounded-md shadow-sm text-sm font-medium text-yellow-700 bg-yellow-50 hover:bg-yellow-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500">
            <i class="fas fa-save mr-2"></i> {% if post and post.draft %}Update Draft{% else %}Save as Draft{% endif %}
          </button>
          <button type="submit" name="action" value="publish" 
                  class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            <i class="fas fa-paper-plane mr-2"></i> {% if post and not post.draft %}Update Published{% else %}Publish Now{% endif %}
          </button>
        </div>
      </div>

    </form>
  </div>

  <!-- Markdown Help -->
  <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
    <h3 class="font-medium text-blue-800 dark:text-blue-300 mb-2 flex items-center">
      <i class="fas fa-info-circle mr-2"></i> Markdown Tips
    </h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-blue-700 dark:text-blue-400">
      <div>
        <p><strong>Headers:</strong> <code># H1</code> <code>## H2</code> <code>### H3</code></p>
        <p><strong>Bold:</strong> <code>**bold text**</code></p>
        <p><strong>Italic:</strong> <code>*italic text*</code></p>
      </div>
      <div>
        <p><strong>Code:</strong> <code>`inline code`</code></p>
        <p><strong>Lists:</strong> <code>- item</code> or <code>1. item</code></p>
        <p><strong>Links:</strong> <code>[text](url)</code></p>
      </div>
    </div>
  </div>
</div>

<script>
  // Character count
  const contentTextarea = document.getElementById('content');
  const charCount = document.getElementById('charCount');

  contentTextarea.addEventListener('input', function() {
    const length = this.value.length;
    charCount.textContent = `${length.toLocaleString()} characters`;
    
    // Update color based on length
    if (length < 100) {
      charCount.className = 'text-xs text-red-500';
    } else if (length < 500) {
      charCount.className = 'text-xs text-yellow-500';
    } else {
      charCount.className = 'text-xs text-green-500';
    }
  });

  // Auto-generate slug from title (only for new posts)
  const titleInput = document.getElementById('title');
  const slugInput = document.getElementById('slug');

  {% if not post %}
  titleInput.addEventListener('blur', function() {
    if (!slugInput.value && this.value) {
      const slug = this.value
        .toLowerCase()
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .replace(/(^-|-$)/g, '');
      slugInput.value = slug;
    }
  });
  {% endif %}

  // Form validation
  const form = document.querySelector('form');
  form.addEventListener('submit', function(e) {
    const title = titleInput.value.trim();
    const content = contentTextarea.value.trim();
    
    let isValid = true;
    
    if (!title) {
      titleInput.classList.add('border-red-500');
      isValid = false;
    }
    
    if (!content) {
      contentTextarea.classList.add('border-red-500');
      isValid = false;
    }
    
    if (!isValid) {
      e.preventDefault();
      alert('Please fill in all required fields (title and content).');
    }
  });

  // Remove error styling when user types
  titleInput.addEventListener('input', function() {
    this.classList.remove('border-red-500');
  });

  contentTextarea.addEventListener('input', function() {
    this.classList.remove('border-red-500');
  });

  // Initialize character count
  contentTextarea.dispatchEvent(new Event('input'));
</script>

<style>
  .form-group {
    @apply space-y-2;
  }
  
  .form-label {
    @apply block text-sm font-medium text-gray-700 dark:text-gray-300 flex items-center;
  }
  
  .form-input {
    @apply w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white;
  }
  
  .form-textarea {
    @apply resize-vertical;
  }
  
  .form-help-text {
    @apply text-xs text-gray-500 dark:text-gray-400;
  }
  
  code {
    @apply bg-gray-100 dark:bg-gray-700 px-1 rounded text-sm font-mono;
  }
</style>
{% endblock %}